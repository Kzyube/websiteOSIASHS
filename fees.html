<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Osias High School | Fee Portal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --sidebar-bg: #0f172a; /* Slate 900 */
            --sidebar-text: #f8fafc;
            --main-bg: #f1f5f9; /* Slate 100 */
            --card-bg: #ffffff;
            --primary: #2563eb; /* Royal Blue */
            --accent: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --text-dark: #1e293b;
            --text-gray: #64748b;
            --border-light: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--main-bg);
            height: 100vh;
            display: flex;
            overflow: hidden; /* Desktop: App-like feel */
        }

        /* --- LEFT SIDEBAR (FIXED) --- */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            padding: 30px;
            box-shadow: 4px 0 24px rgba(0,0,0,0.1);
            z-index: 20;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .brand {
            display: flex; align-items: center; gap: 15px;
            margin-bottom: 50px;
        }
        /* UPDATED LOGO HERE */
        .brand img { height: 50px; width: auto; object-fit: contain; filter: drop-shadow(0 0 8px rgba(255,255,255,0.2)); }
        .brand-text h1 { font-size: 1.1rem; font-weight: 700; letter-spacing: 0.5px; margin: 0; }
        .brand-text p { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin: 0; }

        /* Profile Area inside Sidebar */
        .profile-section {
            flex: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            opacity: 0.3; pointer-events: none; transition: 0.3s; /* Dimmed until loaded */
        }
        .profile-section.active { opacity: 1; pointer-events: all; }

        .avatar-box {
            width: 120px; height: 120px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: 700; color: white;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3);
            border: 4px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .student-info { text-align: center; margin-bottom: 30px; width: 100%; }
        .student-name { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; color: white; word-wrap: break-word; }
        .student-lrn { 
            background: rgba(255,255,255,0.1); padding: 5px 15px; 
            border-radius: 20px; font-size: 0.85rem; color: #cbd5e1; display: inline-block;
        }

        .sidebar-footer { margin-top: auto; width: 100%; }
        
        .btn-sidebar {
            width: 100%; padding: 15px; margin-top: 10px;
            border: none; border-radius: 12px;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .btn-soa { background: #334155; color: white; border: 1px solid #475569; }
        .btn-soa:hover { background: #475569; border-color: #64748b; }
        .btn-reset { background: transparent; color: #94a3b8; }
        .btn-reset:hover { color: white; background: rgba(255,255,255,0.05); }

        /* --- NEW REGISTRAR STATUS WIDGET CSS --- */
        .registrar-status-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px; /* Spacing above footer */
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .status-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background-color: #64748b; /* Slate 500 */
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
        }
        .status-dot.online { background-color: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.offline { background-color: #ef4444; /* Red */ }

        /* --- RIGHT MAIN CONTENT (SCROLLABLE) --- */
        .main-content {
            flex: 1;
            display: flex; flex-direction: column;
            overflow-y: auto;
            position: relative;
            height: 100%;
        }

        /* Top Header */
        .top-header {
            background: var(--card-bg);
            padding: 20px 40px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-light);
            position: sticky; top: 0; z-index: 10;
        }

        /* Search Bar Design */
        .search-bar-container {
            display: flex; align-items: center;
            background: var(--main-bg);
            border-radius: 12px;
            padding: 5px 5px 5px 20px;
            width: 100%; max-width: 450px; /* Responsive Width */
            border: 1px solid transparent;
            transition: 0.3s;
        }
        .search-bar-container:focus-within {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }
        .search-input {
            border: none; background: transparent;
            flex: 1; font-size: 1rem; color: var(--text-dark);
            min-width: 0; /* Prevents overflow */
        }
        .btn-search {
            background: var(--text-dark); color: white;
            border: none; padding: 10px 20px; border-radius: 8px;
            cursor: pointer; font-weight: 600; transition: 0.2s; white-space: nowrap;
        }
        .btn-search:hover { background: black; }

        .clock-widget { font-weight: 600; color: var(--text-gray); font-size: 0.9rem; white-space: nowrap; }

        /* Announcement Card */
        #announcement-bar {
            background: white;
            color: var(--text-dark);
            padding: 20px 25px;
            border-radius: 16px;
            margin-bottom: 30px;
            border-left: 6px solid #ef4444; /* Red Accent */
            display: none; 
            animation: fadeIn 0.5s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            align-items: center;
        }
        #announcement-bar i { color: #ef4444; font-size: 1.2rem; }
        #announcement-text { font-weight: 600; font-size: 0.95rem; line-height: 1.5; color: #334155; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Content Body */
        .content-body {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- FEE CARDS GRID --- */
        .fee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .fee-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-light);
            position: relative;
            transition: 0.3s;
            display: flex; flex-direction: column; justify-content: space-between;
            height: 180px;
        }
        .fee-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .fee-card.active { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary); background: #eff6ff; }

        .fee-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .fee-icon { 
            width: 40px; height: 40px; border-radius: 10px; 
            background: #f1f5f9; color: var(--text-dark);
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .fee-badge { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 20px; }
        .badge-pending { background: #fff7ed; color: #ea580c; }
        .badge-paid { background: #f0fdf4; color: #16a34a; }
        .badge-overdue { background: #fee2e2; color: #dc2626; }

        .fee-title { font-size: 1.1rem; font-weight: 700; color: var(--text-dark); text-transform: capitalize; }
        .fee-input-area { margin-top: auto; display: flex; align-items: center; justify-content: space-between; }
        
        .pay-input {
            width: 100%; border: none; background: transparent;
            font-size: 1.5rem; font-weight: 800; color: var(--primary);
            border-bottom: 2px solid #cbd5e1; padding: 5px 0;
            transition: 0.2s;
        }
        .pay-input:focus { border-color: var(--primary); outline: none; }
        .pay-input:disabled { border-bottom: 1px dashed #cbd5e1; color: #94a3b8; }

        /* Toggle Switch */
        .toggle-switch { position: relative; width: 50px; height: 28px; flex-shrink: 0; margin-left: 15px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e2e8f0; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Payment Bar */
        .payment-bar {
            background: var(--text-dark);
            color: white;
            padding: 20px 30px;
            border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 15px 30px rgba(15, 23, 42, 0.15);
            margin-bottom: 30px;
        }
        .total-label { font-size: 0.85rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }
        .total-value { font-size: 2rem; font-weight: 800; line-height: 1; }
        
        .btn-pay {
            background: var(--success); color: white; border: none;
            padding: 15px 40px; border-radius: 12px;
            font-weight: 700; font-size: 1rem; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .btn-pay:hover { background: #059669; transform: scale(1.05); }

        /* Loader & Hidden States */
        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 60px; color: var(--text-gray); }
        .empty-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.3; }

        .loader { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; margin: 50px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- RESPONSIVE / MOBILE CSS (REVISED) --- */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow: auto; height: auto; min-height: 100vh; }
            .sidebar { width: 100%; padding: 20px; height: auto; display: block; }
            .brand { margin-bottom: 15px; justify-content: center; }
            .profile-section { display: flex !important; opacity: 0.3; margin-bottom: 15px; }
            .profile-section.active { opacity: 1; }
            .avatar-box { width: 60px; height: 60px; font-size: 1.5rem; margin: 0 auto 10px auto; }
            .student-name { font-size: 1.2rem; }
            .sidebar-footer { display: block !important; margin-top: 10px; }
            .profile-section .btn-sidebar { margin-bottom: 10px; }
            .main-content { overflow: visible; height: auto; }
            .content-body { padding: 20px; }
            .top-header { padding: 15px 20px; flex-direction: column; gap: 15px; position: relative; }
            .search-bar-container { width: 100%; }
            .clock-widget { font-size: 0.8rem; }
            .payment-bar { flex-direction: column; gap: 20px; text-align: center; padding: 20px; }
            .btn-pay { width: 100%; justify-content: center; }
            .fee-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand">
            <img src="images/logoOSIAS.png" alt="School Logo" id="schoolLogo">
            <div class="brand-text">
                <h1>OSIAS HIGH</h1>
                <p>Student Portal</p>
            </div>
        </div>

        <div id="profileSection" class="profile-section">
            <div class="avatar-box" id="avatarInitials">--</div>
            <div class="student-info">
                <h2 class="student-name" id="studentName">Student Name</h2>
                <span class="student-lrn">LRN: <span id="displayLRN">...</span></span>
            </div>
            
            <button class="btn-sidebar btn-soa" onclick="generateSOA()">
                <i class="fas fa-download"></i> SOA
            </button>
        </div>

        <div class="registrar-status-card">
            <div id="status-dot" class="status-dot offline"></div>
            <div style="text-align: left;">
                <div style="font-size: 0.75rem; color: #94a3b8;">Registrar Status</div>
                <div id="status-text" style="font-weight: 600; font-size: 0.95rem; color: white;">Checking...</div>
            </div>
        </div>

        <div class="sidebar-footer">
            <button class="btn-sidebar btn-reset" onclick="location.reload()">
                <i class="fas fa-sign-out-alt"></i> Exit
            </button>
        </div>
    </aside>

    <main class="main-content">
        
        <header class="top-header">
            <div class="search-bar-container">
                <i class="fas fa-search" style="color: #94a3b8; margin-right: 10px;"></i>
                <input type="text" id="lrnInput" class="search-input" placeholder="Enter Student LRN..." onkeypress="if(event.key==='Enter') checkBalance()">
                <button class="btn-search" onclick="checkBalance()">Search</button>
            </div>
            <div id="liveClock" class="clock-widget">Loading Time...</div>
        </header>

        <div class="content-body">
            
            <div id="announcement-bar">
                <div style="display:flex; gap:15px; align-items:center;">
                    <i class="fas fa-bullhorn"></i> 
                    <span id="announcement-text">Loading...</span>
                </div>
            </div>

            <div id="loadingView" class="hidden"><div class="loader"></div></div>

            <div id="emptyState" class="empty-state">
                <i class="fas fa-id-card empty-icon"></i>
                <h2>Welcome to the Portal</h2>
                <p>Please enter your LRN above to view your fees.</p>
            </div>

            <div id="resultView" class="hidden">
                
                <h3 class="section-header">Fee Assessment</h3>
                <form id="feeForm">
                    <div class="fee-grid" id="feeGridContainer"></div>
                </form>

                <div class="payment-bar">
                    <div>
                        <div class="total-label">Total Amount to Pay</div>
                        <div class="total-value">₱ <span id="totalTxt">0.00</span></div>
                    </div>
                    <button class="btn-pay" onclick="processPayment()">
                        <i class="fas fa-receipt"></i> Generate Payment Ticket
                    </button>
                </div>

            </div>
        </div>
    </main>

    <script>
        // ----------------------------------------------------
        // PASTE YOUR GOOGLE SCRIPT URL HERE
        // ----------------------------------------------------
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzlFOu-d4cvNfMB4j6kIIv0dgEXvczDcSiU7--6Gemdtu4ctxxD2nK4ML-KiegTr1fp/exec"; 
        
        let gName = "", gLRN = "";
        let gStudentData = null; 

        window.onload = function() {
            updateClock();
            setInterval(updateClock, 1000);

            if(WEB_APP_URL.includes("PASTE_YOUR")) {
                alert("Reminder: Paste Google Script URL in code line 360!");
                return;
            }

            fetch(WEB_APP_URL + "?action=getAnnouncement")
            .then(response => response.json())
            .then(data => {
                if (data.message && data.message.trim() !== "") {
                    document.getElementById('announcement-text').innerText = data.message;
                    document.getElementById('announcement-bar').style.display = 'flex';
                }
            })
            .catch(e => console.log("Announcement Error:", e));

            // NEW: Fetch Registrar Status on Load
            checkRegistrarStatus();
            // Optional: Poll every 60 seconds
            setInterval(checkRegistrarStatus, 60000);
        };

        // --- NEW STATUS CHECK FUNCTION ---
        async function checkRegistrarStatus() {
            try {
                // Using POST to match the code.gs 'doPost' handling
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getRegistrarStatus' })
                });
                const data = await response.json();
                
                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                
                if (data.status === 'Online') {
                    dot.className = 'status-dot online';
                    text.innerText = "Online";
                } else {
                    dot.className = 'status-dot offline';
                    text.innerText = "Offline";
                }
            } catch (e) {
                console.log("Status check failed", e);
            }
        }

        function updateClock() {
            const now = new Date();
            const options = { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' };
            document.getElementById('liveClock').innerText = now.toLocaleString('en-US', options);
        }

        function getQRCodeBase64(text) {
            const qr = new QRious({ value: text, size: 200, level: 'H' });
            return qr.toDataURL();
        }

        // Helper to convert img element to base64 for PDF
        function getImageDataUrl(imgElement) {
            const canvas = document.createElement("canvas");
            canvas.width = imgElement.width || 100;
            canvas.height = imgElement.height || 100;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL("image/png");
        }

        function checkBalance() {
            const lrn = document.getElementById('lrnInput').value.trim();
            if(!lrn) return alert("Please enter a valid LRN");

            document.getElementById('loadingView').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultView').classList.add('hidden');
            document.getElementById('profileSection').classList.remove('active');

            fetch(WEB_APP_URL + "?lrn=" + lrn)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('loadingView').classList.add('hidden');
                    if(data.found) {
                        gName = data.name;
                        gLRN = lrn;
                        gStudentData = data; 
                        renderData(data);
                    } else {
                        alert("LRN not found in database.");
                        document.getElementById('emptyState').classList.remove('hidden');
                    }
                })
                .catch(e => {
                    console.error("Fetch Error:", e);
                    alert("Connection Error. Please check your internet.");
                    document.getElementById('loadingView').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                });
        }

        // --- NEW DYNAMIC RENDERER ---
        function renderData(d) {
            document.getElementById('resultView').classList.remove('hidden');
            document.getElementById('profileSection').classList.add('active'); 
            
            document.getElementById('studentName').innerText = d.name;
            document.getElementById('displayLRN').innerText = gLRN;
            
            const initials = d.name.split(" ").map(n=>n[0]).join("").substring(0,2);
            document.getElementById('avatarInitials').innerText = initials;

            // Clear old hardcoded grid
            const container = document.getElementById('feeGridContainer');
            container.innerHTML = "";

            // Loop through the dynamic fees array
            if(d.fees && d.fees.length > 0) {
                d.fees.forEach((fee, index) => {
                    createFeeCard(container, fee, index);
                });
            } else {
                container.innerHTML = "<p>No fees assigned.</p>";
            }
            
            calcTotal();
        }

        function createFeeCard(container, fee, index) {
            const status = fee.status ? fee.status : "Pending";
            const isPaid = status.toLowerCase() === 'paid';
            const amount = parseFloat(fee.amount);
            
            // Determine styles based on status
            let badgeClass = "badge-pending";
            if(isPaid) badgeClass = "badge-paid";
            else if(status.toLowerCase() === 'overdue') badgeClass = "badge-overdue";

            // Determine Icon (Optional: Simple logic to guess icon based on name)
            let iconClass = "fa-file-invoice-dollar";
            const nameLower = fee.name.toLowerCase();
            if(nameLower.includes("pta")) iconClass = "fa-users";
            else if(nameLower.includes("misc")) iconClass = "fa-book";
            else if(nameLower.includes("id") || nameLower.includes("lanyard")) iconClass = "fa-id-badge";

            const html = `
            <div class="fee-card" id="card_${index}">
                <div class="fee-header">
                    <div class="fee-icon"><i class="fas ${iconClass}"></i></div>
                    <span class="fee-badge ${badgeClass}">${status}</span>
                </div>
                <div class="fee-title">${fee.name.replace("_", " ")}</div>
                <div class="fee-input-area">
                    <span style="font-size:1.2rem; font-weight:700; color:#94a3b8; margin-right:5px;">₱</span>
                    <input type="hidden" id="max_${index}" value="${amount}">
                    <input type="number" id="in_${index}" class="pay-input dynamic-input" 
                           placeholder="${isPaid ? 'Paid' : amount}" 
                           disabled 
                           oninput="calcTotal()">
                    <label class="toggle-switch">
                        <input type="checkbox" id="chk_${index}" 
                               class="dynamic-checkbox"
                               data-index="${index}"
                               ${isPaid ? 'disabled' : ''} 
                               onchange="toggleDynamicFee(${index})">
                        <span class="slider"></span>
                    </label>
                </div>
                <input type="hidden" id="key_${index}" value="${fee.keyFee}">
                <input type="hidden" id="name_${index}" value="${fee.name}">
            </div>`;
            
            container.innerHTML += html;
        }

        function toggleDynamicFee(index) {
            const chk = document.getElementById(`chk_${index}`);
            const input = document.getElementById(`in_${index}`);
            const card = document.getElementById(`card_${index}`);
            const max = document.getElementById(`max_${index}`).value;

            if(chk.checked) {
                input.disabled = false;
                input.value = max;
                card.classList.add('active');
                input.focus();
            } else {
                input.disabled = true;
                input.value = "";
                card.classList.remove('active');
            }
            calcTotal();
        }

        function calcTotal() {
            let sum = 0;
            // Find all inputs generated dynamically
            const inputs = document.querySelectorAll('.dynamic-input');
            
            inputs.forEach(input => {
                if(!input.disabled && input.value) {
                    // Safety check max value
                    const idParts = input.id.split("_"); 
                    const idx = idParts[1];
                    const max = parseFloat(document.getElementById(`max_${idx}`).value);
                    
                    let val = parseFloat(input.value);
                    if(val > max) { val = max; input.value = max; }
                    if(val < 0) { val = 0; input.value = 0; }
                    
                    sum += val;
                }
            });
            document.getElementById('totalTxt').innerText = sum.toLocaleString(undefined, {minimumFractionDigits: 2});
        }

        function processPayment() {
            const items = [];
            let total = 0;
            
            // Loop through all checkboxes to find selected items
            const checkboxes = document.querySelectorAll('.dynamic-checkbox');
            
            checkboxes.forEach(chk => {
                if(chk.checked) {
                    const idx = chk.getAttribute('data-index');
                    const name = document.getElementById(`name_${idx}`).value;
                    const val = document.getElementById(`in_${idx}`).value;
                    
                    items.push({name: name, amt: val});
                    total += parseFloat(val || 0);
                }
            });

            if(total <= 0) return alert("Select at least one fee to pay.");

            const ticketNo = "T-" + Math.floor(100000 + Math.random() * 900000);
            
            // Send to backend (optional logging)
            const payload = {
                action: 'recordPayment', // Note: You might need to add this action to your backend if you want to save it strictly, otherwise it's just for receipt
                lrn: gLRN, name: gName, total: total,
                fees: items.map(i=>`${i.name}(${i.amt})`).join(", ")
            };
            
            // Fire and forget log
            fetch(WEB_APP_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify(payload)
            });

            generateReceipt(ticketNo, items, total);
        }

        // --- UPDATED TICKET GENERATION FUNCTION ---
        function generateReceipt(ticketNo, items, total) {
            const { jsPDF } = window.jspdf;
            
            // Increase height dynamically based on items
            const baseHeight = 180;
            const itemHeight = items.length * 10;
            const doc = new jsPDF({ unit: 'mm', format: [80, baseHeight + itemHeight] });
            
            const centerX = 40;
            let y = 10;
            const currentDateTime = new Date().toLocaleString('en-US'); 

            // -- 1. Logo Handling --
            // Try to capture the logo from sidebar, otherwise fallback to text
            try {
                const logoEl = document.getElementById('schoolLogo');
                const logoData = getImageDataUrl(logoEl);
                doc.addImage(logoData, 'PNG', 28, y, 24, 24); // Centered logo
                y += 28;
            } catch(e) {
                console.log("Logo load failed for PDF", e);
                y += 5; // spacing if logo fails
            }

            // -- 2. Header --
            doc.setFont("helvetica", "bold"); doc.setFontSize(11);
            doc.text("OSIAS HIGH SCHOOL", centerX, y, null, null, "center"); y += 5;
            doc.setFont("helvetica", "normal"); doc.setFontSize(8);
            doc.text("Official Payment Ticket", centerX, y, null, null, "center"); y += 8;

            // -- 3. Ticket Info Box --
            doc.setDrawColor(200); doc.setFillColor(245, 245, 245);
            doc.rect(5, y, 70, 14, 'F'); // Gray box
            doc.setFont("courier", "bold"); doc.setFontSize(10);
            doc.text(`TICKET #: ${ticketNo}`, centerX, y + 5, null, null, "center");
            doc.setFont("helvetica", "normal"); doc.setFontSize(7);
            doc.text(currentDateTime, centerX, y + 10, null, null, "center");
            y += 20;

            // -- 4. Student Details --
            doc.setFontSize(9);
            doc.text(`Student:`, 5, y);
            doc.setFont("helvetica", "bold");
            doc.text(gName.substring(0, 22) + (gName.length>22?"...":""), 80 - 5, y, null, null, "right"); y += 5;
            
            doc.setFont("helvetica", "normal");
            doc.text(`LRN:`, 5, y);
            doc.setFont("helvetica", "bold");
            doc.text(gLRN, 80 - 5, y, null, null, "right"); y += 5;

            // Dashed Line Separator
            doc.setLineDashPattern([1, 1], 0);
            doc.line(5, y, 75, y);
            doc.setLineDashPattern([], 0); // Reset
            y += 6;

            // -- 5. Items List --
            doc.setFontSize(8); doc.setTextColor(50);
            items.forEach(i => {
                const amt = parseFloat(i.amt).toFixed(2);
                doc.setFont("helvetica", "normal");
                doc.text(i.name.replace("_", " "), 5, y);
                doc.setFont("helvetica", "bold");
                doc.text(amt, 75, y, null, null, "right");
                y += 5;
            });
            doc.setTextColor(0);

            // Dashed Line Separator
            y += 2;
            doc.setLineDashPattern([1, 1], 0);
            doc.line(5, y, 75, y);
            doc.setLineDashPattern([], 0); // Reset
            y += 8;

            // -- 6. Total --
            doc.setFontSize(10); doc.setFont("helvetica", "bold");
            doc.text("TOTAL AMOUNT:", 5, y);
            doc.setFontSize(14);
            doc.text("P " + total.toFixed(2), 75, y, null, null, "right"); y += 15;

            // -- 7. Footer & QR --
            const qrData = getQRCodeBase64(gLRN); 
            doc.addImage(qrData, 'JPEG', 25, y, 30, 30);
            y += 35;

            doc.setFontSize(7); doc.setFont("helvetica", "italic"); doc.setTextColor(100);
            doc.text("Show this digital ticket to the Registrar", centerX, y, null, null, "center"); y+=4;
            doc.text("for verification and clearance.", centerX, y, null, null, "center");
            
            doc.save(`Ticket_${gLRN}.pdf`);
        }

        function generateSOA() {
            if(!gStudentData) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const today = new Date().toLocaleDateString();

            doc.setFont("helvetica", "bold"); doc.setFontSize(18);
            doc.setTextColor(40, 40, 40);
            doc.text("OSIAS HIGH SCHOOL", 105, 20, null, null, "center");
            
            doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.setTextColor(100);
            doc.text("OFFICIAL STATEMENT OF ACCOUNT", 105, 28, null, null, "center");
            doc.setDrawColor(200); doc.line(20, 34, 190, 34);

            doc.setFontSize(11); doc.setTextColor(0);
            doc.text(`Student: ${gName}`, 20, 45);
            doc.text(`LRN: ${gLRN}`, 20, 51);
            doc.text(`Date: ${today}`, 190, 45, null, null, "right");

            doc.setFontSize(12); doc.setFont("helvetica", "bold");
            doc.text("Current Obligations", 20, 65);

            // Use the DYNAMIC fees array from gStudentData
            const fees = gStudentData.fees || [];

            doc.autoTable({
                startY: 70,
                head: [['Description', 'Status', 'Amount Due']],
                body: fees.map(f => [ f.name, (f.status||"Pending").toUpperCase(), (f.status||"").toLowerCase() === 'paid' ? '0.00' : parseFloat(f.amount).toFixed(2) ]),
                theme: 'grid', headStyles: { fillColor: [67, 97, 238] }
            });

            let totalBalance = 0;
            fees.forEach(f => { if((f.status||"").toLowerCase() !== 'paid') totalBalance += parseFloat(f.amount||0); });
            
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.text("TOTAL BALANCE:", 110, finalY);
            doc.setTextColor(200, 0, 0);
            doc.text(`P ${totalBalance.toLocaleString(undefined, {minimumFractionDigits:2})}`, 190, finalY, null, null, "right");
            doc.setTextColor(0);

            doc.save(`${gName}_SOA.pdf`);
        }
    </script>
</body>
</html>
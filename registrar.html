<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Admin Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* KEEPING YOUR EXISTING CSS */
        :root { --primary: #4e73df; --secondary: #858796; --success: #1cc88a; --danger: #e74a3b; --light: #f8f9fc; --dark: #5a5c69; --shadow: 0 4px 6px rgba(0,0,0,0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #f0f2f5; color: #333; height: 100vh; overflow: hidden; }

        /* Login */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4e73df, #224abe); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }
        
        /* Layout */
        .wrapper { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; z-index: 10; }
        .brand { padding: 20px; font-size: 1.2rem; font-weight: 600; color: var(--primary); border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 10px; }
        .nav-links { flex: 1; padding: 20px 0; }
        .nav-item { padding: 15px 25px; cursor: pointer; color: var(--secondary); transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background: #f8f9fc; color: var(--primary); border-right: 4px solid var(--primary); }
        
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #f8f9fc; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 1.5rem; font-weight: 600; color: var(--dark); }
        
        /* Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: var(--shadow); border-left: 4px solid var(--primary); }
        .card-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); margin-bottom: 10px; }
        .card-value { font-size: 1.8rem; font-weight: 600; color: var(--dark); }

        /* Tables & Lists */
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .search-bar { width: 100%; padding: 15px; border: none; border-radius: 30px; box-shadow: var(--shadow); margin-bottom: 20px; padding-left: 50px; font-size: 1rem; }
        .search-container { position: relative; max-width: 600px; margin-bottom: 30px; }
        .search-icon { position: absolute; left: 20px; top: 15px; color: var(--secondary); }

        .student-details-card { background: white; border-radius: 10px; box-shadow: var(--shadow); overflow: hidden; }
        .student-header { padding: 20px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .fee-list { padding: 20px; }
        .fee-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        .fee-input { width: 100px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: right; }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; }
        .status-paid { background: #e6fffa; color: var(--success); }
        .status-pending { background: #fff5f5; color: var(--danger); }

        /* Buttons */
        .btn-save { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 500; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-danger { background: var(--danger); }

        /* Loader */
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-card { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        /* Notification */
        #notif-toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1001; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px; }
        #notif-toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* NEW ADDITIONS FOR LAYOUT FIXES */
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; width: 100%; } 
        .input-row input { flex: 1; min-width: 0; padding: 10px; border: 1px solid #ddd; border-radius: 6px; } 
        .remove-row-btn { color: var(--danger); cursor: pointer; padding: 5px; font-size: 1.2rem; flex-shrink: 0; }
        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.3s; }
        .fee-setup-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; } 
        .fee-setup-item { background: #f8f9fc; padding: 10px; border-radius: 8px; border: 1px solid #e3e6f0; }
        .fee-setup-item label { font-size: 0.85rem; font-weight: 600; color: var(--dark); display: block; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .fee-setup-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }

        /* == FIXED BUTTON CLASS FOR SAME SIZE == */
        .btn-header {
            font-size: 1rem;
            padding: 0 20px; /* Horizontal padding only */
            height: 45px;    /* Fixed Height for consistency */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-header:hover { background: #3b5cb8; }

        /* History Table Styles */
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .history-table th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; color: var(--secondary); font-weight: 500; }
        .history-table td { padding: 10px; border-bottom: 1px solid #f8f9fc; }
        .history-amount { text-align: right; font-weight: 600; color: var(--success); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2 style="color: var(--primary); margin-bottom: 10px;">Registrar Admin</h2>
            <p style="color: var(--secondary); margin-bottom: 20px;">Enter credentials</p>
            <input type="text" id="access-user" class="login-input" placeholder="Username" onkeypress="handleLoginEnter(event)">
            <input type="password" id="access-pass" class="login-input" placeholder="Password" onkeypress="handleLoginEnter(event)">
            <button class="login-btn" onclick="checkLogin()">Login</button>
            <p id="login-error" style="color: var(--danger); font-size: 0.9rem; margin-top: 10px; display: none;">Invalid Username or Password</p>
        </div>
    </div>

    <div id="notif-toast">Notification Message</div>

    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: var(--primary); font-weight: 500;">Processing...</p>
    </div>

    <div class="wrapper">
        <div class="sidebar">
            <div class="brand">
                <i class="fas fa-school"></i> Admin Portal
            </div>
            <div class="nav-links">
                <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</div>
                <div class="nav-item" onclick="switchTab('fees')"><i class="fas fa-search"></i> Manage Fees</div>
                <div class="nav-item" onclick="switchTab('students')"><i class="fas fa-users"></i> Students</div>
                <div class="nav-item" onclick="switchTab('settings')"><i class="fas fa-cog"></i> Settings</div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="dashboard-tab" class="content-section active">
                <div class="header">
                    <div class="page-title">Dashboard Overview</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-header" onclick="openHistoryModal()">
                            <i class="fas fa-history"></i> Collection History
                        </button>
                        <button class="btn-header" onclick="loadDashboard()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="card">
                        <div class="card-title">Daily Collection</div>
                        <div class="card-value" id="daily-collection">₱0.00</div>
                    </div>
                    <div class="card" style="border-left-color: var(--success);">
                        <div class="card-title">Students Paid (Today)</div>
                        <div class="card-value" id="count-paid">0</div>
                    </div>
                    <div class="card" style="border-left-color: var(--danger);">
                        <div class="card-title">Pending / Overdue</div>
                        <div class="card-value" id="count-pending">0</div>
                    </div>
                </div>
                <div class="card" style="height: 400px; display: flex; flex-direction: column;">
                    <div class="card-title">Payment Status Overview</div>
                    <div style="flex: 1; position: relative; min-height: 0;">
                        <canvas id="collectionChart"></canvas>
                        <div id="chart-no-data" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--secondary);">
                            <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>No student status data found.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="fees-tab" class="content-section">
                <div class="header">
                    <div class="page-title">Search & Manage Student Fees</div>
                    <button class="btn-header" onclick="toggleCamera()">
                        <i class="fas fa-qrcode"></i> Scan QR
                    </button>
                </div>

                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-bar" id="lrnInput" placeholder="Enter Student LRN or Scan QR...">
                    <button class="login-btn" onclick="runSearch()" style="width: auto; position: absolute; right: 5px; top: 5px; padding: 10px 20px;">Search</button>
                </div>

                <div id="scanner-container" style="display: none; width: 300px; margin: 0 auto 20px auto;">
                    <div id="reader"></div>
                    <button onclick="stopCamera()" class="btn-sm btn-danger" style="width:100%; margin-top:5px;">Close Camera</button>
                </div>

                <div id="student-result" style="display: none;">
                    <div class="student-details-card">
                        <div class="student-header">
                            <div>
                                <h3 id="res-name">Student Name</h3>
                                <small id="res-lrn">LRN: 123456</small>
                            </div>
                            <button class="btn-save" onclick="saveChanges()">Save Changes</button>
                        </div>
                        <div class="fee-list" id="fee-list-container">
                            </div>
                    </div>
                </div>
            </div>

            <div id="students-tab" class="content-section">
                <div class="header">
                    <div class="page-title">All Students</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-header" onclick="openAddStudentModal()">
                            <i class="fas fa-user-plus"></i> Add Students
                        </button>
                        <button class="btn-header" onclick="loadStudents()">
                            <i class="fas fa-sync-alt"></i> Refresh List
                        </button>
                    </div>
                </div>
                <div class="card">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 2px solid #f0f0f0;">
                                <th style="padding: 10px;">LRN</th>
                                <th style="padding: 10px;">Name</th>
                                <th style="padding: 10px; text-align: right;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="all-students-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="settings-tab" class="content-section">
                <div class="header">
                    <div class="page-title">Settings & Configuration</div>
                </div>
                
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Public Announcement</h3>
                    <p style="color: var(--secondary); font-size: 0.9rem; margin-bottom: 10px;">This text will scroll on the student portal.</p>
                    <input type="text" id="announce-input" class="search-bar" placeholder="Enter announcement text..." style="padding-left: 15px;">
                    <button class="login-btn" onclick="saveAnnouncement()" style="width: auto;">Update Announcement</button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Fee Structure Management</h3>
                    <p style="color: var(--secondary); font-size: 0.9rem; margin-bottom: 20px;">Add or remove fee types. "Amount" is the default for bulk updates.</p>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="new-fee-name" class="login-input" placeholder="New Fee Name (e.g. PTA)" style="margin: 0;">
                        <button class="btn-sm" style="background: var(--success);" onclick="addNewFeeType()">Add Fee</button>
                    </div>
                    
                    <div id="fee-settings-list">
                        </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-add-student" class="modal-overlay">
        <div class="modal-card" style="max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 style="color: var(--dark);"><i class="fas fa-user-plus"></i> Add Students</h3>
                <button onclick="closeAddStudentModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <div style="flex: 1; overflow-y: auto; padding-right: 5px;">
                <div id="step-1" class="step-container active">
                    <p style="color: var(--secondary); font-size: 0.9rem; margin-bottom: 15px;">
                        Enter LRN and Name. You can add multiple students at once.
                    </p>
                    <div id="student-rows-container">
                        </div>
                    <button onclick="addStudentInputRow()" class="btn-sm" style="background: var(--secondary); margin-top: 10px;">+ Add Another Row</button>
                    
                    <div class="modal-actions" style="margin-top: 20px;">
                        <button class="login-btn" onclick="goToStep2()" style="width: auto;">Next: Set Fees <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <div id="step-2" class="step-container">
                    <p style="color: var(--secondary); font-size: 0.9rem;">
                        (Optional) Set initial fee balance for these new students. <br>
                        Leave as <strong>0</strong> to mark as Paid/No Balance.
                    </p>
                    
                    <div id="initial-fees-container" class="fee-setup-grid">
                        <div style="text-align:center; width:100%;">Loading Active Fees...</div>
                    </div>

                    <div class="modal-actions" style="margin-top: 20px;">
                        <button class="login-btn" onclick="backToStep1()" style="background: var(--secondary); width: auto;">Back</button>
                        <button class="login-btn" onclick="submitNewStudents()" style="background: var(--success); width: auto;">Submit & Save</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-history" class="modal-overlay">
        <div class="modal-card" style="max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 style="color: var(--dark);"><i class="fas fa-history"></i> Collection History</h3>
                <button onclick="closeHistoryModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div style="flex: 1; overflow-y: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th style="text-align: right;">Total Collected</th>
                        </tr>
                    </thead>
                    <tbody id="history-rows">
                        <tr><td colspan="2" style="text-align:center; padding:20px;">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzlFOu-d4cvNfMB4j6kIIv0dgEXvczDcSiU7--6Gemdtu4ctxxD2nK4ML-KiegTr1fp/exec"; 

        // --- AUTHENTICATION ---
        function handleLoginEnter(e) { if(e.key === 'Enter') checkLogin(); }
        
        function checkLogin() {
            const user = document.getElementById('access-user').value;
            const pass = document.getElementById('access-pass').value;
            if(user === 'OsiasRegistrar' && pass === 'OHS2005') { 
                document.getElementById('login-overlay').style.display = 'none';
                loadDashboard();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        // --- NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId + '-tab').classList.add('active');
            
            // Highlight nav
            const navs = document.querySelectorAll('.nav-item');
            if(tabId === 'dashboard') navs[0].classList.add('active');
            if(tabId === 'fees') navs[1].classList.add('active');
            if(tabId === 'students') { navs[2].classList.add('active'); loadStudents(); }
            if(tabId === 'settings') { navs[3].classList.add('active'); loadSettings(); }
        }

        // --- API HANDLER ---
        async function callApi(payload) {
            toggleLoader(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                toggleLoader(false);
                return data;
            } catch (error) {
                toggleLoader(false);
                showNotif("Network Error: " + error, "red");
                return { error: error };
            }
        }

        function toggleLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        function showNotif(msg, color="green") {
            const toast = document.getElementById("notif-toast");
            toast.innerText = msg;
            toast.style.backgroundColor = color === "red" ? "var(--danger)" : "#333";
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- DASHBOARD ---
        function loadDashboard() {
            callApi({ action: 'getDailyReport' }).then(data => {
                const paidCount = data.stats.paid;
                const pendingCount = (data.stats.pending + data.stats.overdue);

                document.getElementById('daily-collection').innerText = "₱" + data.total.toLocaleString();
                document.getElementById('count-paid').innerText = paidCount;
                document.getElementById('count-pending').innerText = pendingCount;

                // Pass the actual counts to the chart
                renderChart(paidCount, pendingCount);
            });
        }

        // --- UPDATED CHART TO SHOW PAID vs PENDING ---
        function renderChart(paid, pending) {
            // DOM Elements
            const canvas = document.getElementById('collectionChart');
            const noDataMsg = document.getElementById('chart-no-data');
            
            // Destroy existing chart to prevent overlaps
            if(window.myChart instanceof Chart) {
                window.myChart.destroy();
            }

            const total = paid + pending;

            if (total === 0) {
                // Hide Canvas, Show Message
                canvas.style.display = 'none';
                noDataMsg.style.display = 'block';
            } else {
                // Show Canvas, Hide Message
                canvas.style.display = 'block';
                noDataMsg.style.display = 'none';

                window.myChart = new Chart(canvas, {
                    type: 'pie',
                    data: {
                        labels: ['Paid Students', 'Pending / Overdue'],
                        datasets: [{
                            data: [paid, pending],
                            backgroundColor: ['#1cc88a', '#e74a3b'], // Green and Red
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: {
                                display: true, 
                                position: 'bottom'
                            } 
                        } 
                    }
                });
            }
        }

        // --- STUDENT SEARCH & FEES ---
        let currentStudentRow = null;
        let currentFees = [];

        function runSearch() {
            const lrn = document.getElementById('lrnInput').value;
            if(!lrn) return showNotif("Please enter LRN", "red");
            
            callApi({ action: 'search', lrn: lrn }).then(res => {
                if(res.found) {
                    document.getElementById('student-result').style.display = 'block';
                    document.getElementById('res-name').innerText = res.name;
                    document.getElementById('res-lrn').innerText = "LRN: " + lrn;
                    currentStudentRow = res.rowIndex;
                    currentFees = res.fees;
                    renderFees(res.fees);
                } else {
                    document.getElementById('student-result').style.display = 'none';
                    showNotif("Student not found", "red");
                }
            });
        }

        function renderFees(fees) {
            const container = document.getElementById('fee-list-container');
            container.innerHTML = "";
            fees.forEach((f, idx) => {
                const div = document.createElement('div');
                div.className = "fee-item";
                const badgeClass = f.status === 'Paid' ? 'status-paid' : 'status-pending';
                
                div.innerHTML = `
                    <div>
                        <div style="font-weight:600;">${f.name}</div>
                        <span class="status-badge ${badgeClass}" id="badge-${idx}">${f.status}</span>
                    </div>
                    <div>
                        ₱ <input type="number" class="fee-input" value="${f.amount}" id="amt-${idx}" onchange="updateStatusPreview(${idx})">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateStatusPreview(idx) {
            const val = document.getElementById(`amt-${idx}`).value;
            const badge = document.getElementById(`badge-${idx}`);
            if(Number(val) <= 0) {
                badge.className = "status-badge status-paid";
                badge.innerText = "Paid";
            } else {
                badge.className = "status-badge status-pending";
                badge.innerText = "Pending";
            }
        }

        function saveChanges() {
            const updatedFees = currentFees.map((f, idx) => {
                const val = document.getElementById(`amt-${idx}`).value;
                const stat = Number(val) <= 0 ? "Paid" : "Pending";
                return { keyFee: f.keyFee, keyStat: f.keyStat, amount: val, status: stat };
            });

            callApi({ action: 'update', row: currentStudentRow, fees: updatedFees }).then(res => {
                if(res.success) showNotif("Fees Updated Successfully!");
                else showNotif("Error saving", "red");
            });
        }

        // --- STUDENTS TAB & BULK ADD ---

        function loadStudents() {
            callApi({ action: 'getStudents' }).then(res => {
                const tbody = document.getElementById('all-students-body');
                tbody.innerHTML = "";
                if(res.students && res.students.length > 0) {
                    res.students.forEach(s => {
                        const row = `<tr>
                            <td style="padding: 10px; border-bottom: 1px solid #f0f0f0;">${s.lrn}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #f0f0f0;">${s.name}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #f0f0f0; text-align: right;">
                                <button class="btn-sm" onclick="manageStudent('${s.lrn}')"><i class="fas fa-edit"></i> Manage Fees</button>
                            </td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="3" style="text-align: center;">No students found in database.</td></tr>`;
                }
            }).catch(err => {
                toggleLoader(false);
                showNotif("Failed to load students.", "red");
            });
        }

        function manageStudent(lrn) {
            switchTab('fees');
            document.getElementById('lrnInput').value = lrn;
            runSearch();
        }

        // === NEW MODAL FUNCTIONS FOR ADDING STUDENTS ===

        function openAddStudentModal() {
            document.getElementById('modal-add-student').style.display = 'flex';
            document.getElementById('student-rows-container').innerHTML = ''; // Reset
            addStudentInputRow(); // Add first row
            backToStep1(); // Ensure we start at step 1
        }

        function closeAddStudentModal() {
            document.getElementById('modal-add-student').style.display = 'none';
        }

        function addStudentInputRow() {
            const container = document.getElementById('student-rows-container');
            const rowDiv = document.createElement('div');
            rowDiv.className = 'input-row';
            rowDiv.innerHTML = `
                <input type="text" placeholder="LRN" class="new-student-lrn">
                <input type="text" placeholder="Student Name" class="new-student-name">
                <i class="fas fa-times-circle remove-row-btn" onclick="this.parentElement.remove()"></i>
            `;
            container.appendChild(rowDiv);
        }

        function goToStep2() {
            // Validate Inputs
            const lrnInputs = document.querySelectorAll('.new-student-lrn');
            const nameInputs = document.querySelectorAll('.new-student-name');
            let hasData = false;

            for(let i=0; i<lrnInputs.length; i++) {
                if(lrnInputs[i].value.trim() !== "" && nameInputs[i].value.trim() !== "") {
                    hasData = true;
                } else if (lrnInputs[i].value.trim() !== "" || nameInputs[i].value.trim() !== "") {
                    // Partial data
                    return showNotif("Please complete LRN and Name for all rows.", "red");
                }
            }

            if(!hasData) return showNotif("Please enter at least one student.", "red");

            // Switch view and fetch fees
            document.getElementById('step-1').classList.remove('active');
            document.getElementById('step-2').classList.add('active');
            
            // Fetch dynamic fees
            const feeContainer = document.getElementById('initial-fees-container');
            feeContainer.innerHTML = '<div style="text-align:center;">Loading Active Fees...</div>';
            
            callApi({ action: 'getFeeList' }).then(res => {
                feeContainer.innerHTML = "";
                if(res.fees && res.fees.length > 0) {
                    res.fees.forEach(fee => {
                        feeContainer.innerHTML += `
                            <div class="fee-setup-item">
                                <label>${fee}</label>
                                <input type="number" class="fee-setup-input" data-fee="${fee}" value="0" placeholder="0.00">
                            </div>
                        `;
                    });
                } else {
                    feeContainer.innerHTML = "<div>No active fees found. Students will be added with no balances.</div>";
                }
            });
        }

        function backToStep1() {
            document.getElementById('step-2').classList.remove('active');
            document.getElementById('step-1').classList.add('active');
        }

        function submitNewStudents() {
            // 1. Gather Students
            const students = [];
            const lrnInputs = document.querySelectorAll('.new-student-lrn');
            const nameInputs = document.querySelectorAll('.new-student-name');
            
            for(let i=0; i<lrnInputs.length; i++) {
                if(lrnInputs[i].value.trim() && nameInputs[i].value.trim()) {
                    students.push({
                        lrn: lrnInputs[i].value.trim(),
                        name: nameInputs[i].value.trim()
                    });
                }
            }

            // 2. Gather Initial Fees
            const initialFees = {};
            document.querySelectorAll('.fee-setup-input').forEach(input => {
                const feeName = input.getAttribute('data-fee');
                const amount = input.value;
                if(amount && amount > 0) {
                    initialFees[feeName] = amount;
                }
            });

            // 3. Send API Request
            callApi({
                action: 'addBulkStudents',
                students: students,
                initialFees: initialFees
            }).then(res => {
                if(res.success) {
                    showNotif(res.message);
                    closeAddStudentModal();
                    loadStudents(); // Refresh list
                } else {
                    showNotif("Error: " + res.error, "red");
                }
            });
        }

        // === NEW HISTORY FUNCTIONS ===

        function openHistoryModal() {
            document.getElementById('modal-history').style.display = 'flex';
            const tbody = document.getElementById('history-rows');
            tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px;">Loading data...</td></tr>';
            
            callApi({ action: 'getCollectionHistory' }).then(res => {
                tbody.innerHTML = "";
                if(res.history && res.history.length > 0) {
                    // Sort descending by date (newest first)
                    res.history.sort((a,b) => new Date(b.date) - new Date(a.date));
                    
                    res.history.forEach(h => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${h.date}</td>
                            <td class="history-amount">₱${Number(h.amount).toLocaleString()}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px; color:var(--secondary);">No collection history found.</td></tr>';
                }
            });
        }

        function closeHistoryModal() {
            document.getElementById('modal-history').style.display = 'none';
        }


        // --- SETTINGS TAB ---

        function loadSettings() {
            // Get announcement
            callApi({ action: 'getAnnouncement' }).then(res => {
                document.getElementById('announce-input').value = res.message;
            });
            // Get fees
            loadFeeSettingsList();
        }

        function saveAnnouncement() {
            const msg = document.getElementById('announce-input').value;
            callApi({ action: 'setAnnouncement', message: msg }).then(res => {
                showNotif("Announcement Updated");
            });
        }

        function loadFeeSettingsList() {
             callApi({ action: 'getFeeList' }).then(res => {
                const container = document.getElementById('fee-settings-list');
                container.innerHTML = "";
                if(res.fees) {
                    res.fees.forEach(f => {
                        container.innerHTML += `
                            <div style="background:white; border:1px solid #eee; padding:15px; border-radius:5px; margin-bottom:10px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <strong>${f}</strong>
                                    <div>
                                        <button class="btn-sm" onclick="bulkUpdateFee('${f}')" style="margin-right:5px;">Update All Amounts</button>
                                        <button class="btn-sm btn-danger" onclick="deleteFee('${f}')">Remove</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            });
        }

        function addNewFeeType() {
            const name = document.getElementById('new-fee-name').value;
            if(!name) return;
            callApi({ action: 'addNewFee', feeName: name }).then(res => {
                if(res.success) {
                    showNotif("Fee Added");
                    document.getElementById('new-fee-name').value = "";
                    loadFeeSettingsList();
                }
            });
        }

        function deleteFee(name) {
            if(!confirm("Are you sure? This will delete this fee column for ALL students.")) return;
            callApi({ action: 'removeFee', feeName: name }).then(res => {
                if(res.success) {
                    showNotif("Fee Removed");
                    loadFeeSettingsList();
                }
            });
        }

        function bulkUpdateFee(name) {
            const amt = prompt(`Enter new amount for ${name} for ALL students (Note: This overwrites existing values):`);
            if(amt === null) return;
            callApi({ action: 'bulkUpdateAmount', feeName: name, amount: amt }).then(res => {
                if(res.success) {
                     // Auto update status too
                     callApi({ action: 'bulkUpdateStatus', feeName: name, status: (Number(amt)>0?'Pending':'Paid') }).then(r => {
                         showNotif("Bulk Update Complete");
                     });
                }
            });
        }

        // Scanner
        let html5QrcodeScanner;
        function toggleCamera() {
            const container = document.getElementById('scanner-container');
            if (container.style.display === "block") return;
            container.style.display = "block";
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode("reader");
            }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                container.style.display = "none";
                showNotif("Camera Error: " + err, "red");
            });
        }
        function stopCamera() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('scanner-container').style.display = "none";
                }).catch(err => console.log("Stop failed", err));
            } else {
                document.getElementById('scanner-container').style.display = "none";
            }
        }
        function onScanSuccess(decodedText, decodedResult) {
            stopCamera();
            document.getElementById('lrnInput').value = decodedText;
            runSearch();
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
             // Optional: check session
        });

    </script>
</body>
</html>
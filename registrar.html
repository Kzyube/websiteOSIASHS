<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Admin Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --primary: #4e73df;
            --secondary: #858796;
            --success: #1cc88a;
            --danger: #e74a3b;
            --light: #f8f9fc;
            --dark: #5a5c69;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #f0f2f5; color: #333; height: 100vh; overflow: hidden; }

        /* --- LOGIN SCREEN --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4e73df, #224abe);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 12px;
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .login-form input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #d1d3e2; border-radius: 6px; outline: none;
        }
        .login-btn {
            width: 100%; padding: 12px; background: var(--primary);
            color: white; border: none; border-radius: 6px;
            cursor: pointer; font-weight: 500; transition: 0.2s;
        }
        .login-btn:hover { background: #2e59d9; }

        /* --- ANNOUNCEMENT MODAL (NEW) --- */
        #announce-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); /* Dimmed background */
            display: none; justify-content: center; align-items: center;
            z-index: 2500; backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }
        .announce-card {
            background: white; width: 90%; max-width: 500px;
            border-radius: 15px; padding: 25px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
        }
        .announce-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;
        }
        .live-clock-badge {
            background: #e8f0fe; color: var(--primary);
            padding: 5px 12px; border-radius: 20px;
            font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; gap: 5px;
        }
        .announce-textarea {
            width: 100%; height: 120px; padding: 15px;
            border: 2px solid #e3e6f0; border-radius: 10px;
            resize: none; font-size: 1rem; outline: none; margin-bottom: 20px;
        }
        .announce-textarea:focus { border-color: var(--primary); }
        .announce-actions { display: flex; justify-content: flex-end; gap: 10px; }

        /* --- MAIN APP LAYOUT --- */
        #app-container { display: none; height: 100vh; display: none; }
        
        /* Sidebar */
        .sidebar {
            width: 250px; background: #fff; padding: 20px;
            display: flex; flex-direction: column; border-right: 1px solid #e3e6f0;
        }
        .menu-item {
            padding: 12px 15px; margin-bottom: 5px; border-radius: 8px;
            color: var(--secondary); cursor: pointer; display: flex;
            align-items: center; gap: 10px; transition: 0.2s;
        }
        .menu-item:hover { background-color: var(--light); color: var(--primary); }
        .menu-item.active { background-color: var(--primary); color: white; }

        /* Content Area */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #f0f2f5; }

        /* Sections (Views) */
        .section-view { display: none; animation: fadeIn 0.3s ease; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Components */
        .search-card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: var(--shadow); margin-bottom: 25px;
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
        }
        .search-input {
            width: 100%; padding: 12px; border: 1px solid #d1d3e2;
            border-radius: 8px; outline: none; flex: 1;
        }
        .icon-btn {
            background: none; border: none; cursor: pointer; color: var(--secondary);
            font-size: 1.2rem; transition: 0.2s; padding: 5px;
        }
        .icon-btn:hover { color: var(--primary); }

        /* Camera Container Styles */
        #scanner-container {
            width: 100%; display: none; margin-top: 15px;
            background: #000; border-radius: 8px; overflow: hidden;
            position: relative;
        }
        #reader { width: 100%; }
        .close-cam-btn {
            position: absolute; top: 10px; right: 10px; 
            background: rgba(255,255,255,0.8); border: none; 
            padding: 5px 10px; border-radius: 4px; cursor: pointer; z-index: 10;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .fee-card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: var(--shadow);
        }
        .status-select {
            width: 100%; padding: 8px; border-radius: 20px;
            border: 1px solid #e3e6f0; text-align: center; cursor: pointer;
            margin-top: 5px; outline: none; font-weight: 500;
        }
        /* Status Colors */
        .status-paid { background: #d1fae5; color: #065f46; border-color: #d1fae5; }
        .status-pending { background: #fef3c7; color: #92400e; border-color: #fef3c7; }
        .status-overdue { background: #fee2e2; color: #b91c1c; border-color: #fee2e2; }

        /* Students Table */
        .table-container {
            background: white; border-radius: 12px;
            box-shadow: var(--shadow); overflow: hidden;
        }
        .student-table { width: 100%; border-collapse: collapse; }
        .student-table th {
            background: #f8f9fc; color: var(--primary); font-weight: 600;
            text-align: left; padding: 15px 25px;
        }
        .student-table td {
            padding: 15px 25px; border-bottom: 1px solid #e3e6f0;
            color: var(--dark);
        }
        .student-table tr:hover { background: #fafafa; }
        .btn-sm {
            padding: 6px 12px; font-size: 0.85rem; border-radius: 4px;
            border: none; cursor: pointer; background: var(--primary);
            color: white; transition: 0.2s;
        }
        .btn-sm:hover { background: #2e59d9; }

        /* Loader & Notification */
        .hidden { display: none; }
        #loader {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8);
            display: none; justify-content: center; align-items: center; z-index: 3000;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 25px;
            border-radius: 8px; color: white; transform: translateX(150%);
            transition: 0.3s; z-index: 4000; font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .notification.show { transform: translateX(0); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2 style="color: var(--primary); margin-bottom: 5px;">
                <i class="fas fa-university"></i> Registrar Portal
            </h2>
            <p style="color: var(--secondary); margin-bottom: 25px; font-size: 0.9rem;">Osias High School</p>
            
            <div class="login-form">
                <input type="text" id="username" placeholder="Username" onkeypress="handleLoginEnter(event)">
                <input type="password" id="password" placeholder="Password" onkeypress="handleLoginEnter(event)">
                <button class="login-btn" onclick="checkLogin()">Login</button>
                <div id="loginError" style="color: var(--danger); margin-top:10px; font-size:0.9rem; min-height: 20px;"></div>
            </div>
        </div>
    </div>

    <div id="announce-overlay">
        <div class="announce-card">
            <div class="announce-header">
                <h3 style="color: var(--dark);"><i class="fas fa-bullhorn" style="color: var(--danger);"></i> New Announcement</h3>
                <div class="live-clock-badge">
                    <i class="far fa-clock"></i> <span id="modalClock">Loading...</span>
                </div>
            </div>
            
            <p style="color: var(--secondary); margin-bottom: 10px; font-size: 0.9rem;">
                This message will appear on the Student Portal immediately.
            </p>
            
            <textarea id="announce-msg" class="announce-textarea" placeholder="Type your announcement here..."></textarea>
            
            <div class="announce-actions">
                <button class="login-btn" onclick="closeAnnounceModal()" style="background: var(--secondary); width: auto; padding: 10px 25px;">Cancel</button>
                <button class="login-btn" onclick="submitAnnouncement()" style="background: var(--danger); width: auto; padding: 10px 25px;">Post Now</button>
            </div>
        </div>
    </div>

    <div id="app-container" style="display: none;"> <div id="loader"><div class="spinner"></div></div>
        <div id="notification" class="notification"></div>

        <div class="sidebar">
            <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 30px; padding-left: 10px;">
                <i class="fas fa-university"></i> OHS Admin
            </div>
            
            <div class="menu-item active" id="nav-fees" onclick="switchTab('fees')">
                <i class="fas fa-money-check-alt"></i> Fee Management
            </div>
            <div class="menu-item" id="nav-students" onclick="switchTab('students')">
                <i class="fas fa-users"></i> Students
            </div>
            <div class="menu-item" onclick="showNotif('Settings unavailable', 'red')">
                <i class="fas fa-cog"></i> Settings
            </div>
            
            <div style="margin-top: auto;">
                <div class="menu-item" onclick="location.reload()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="view-fees" class="section-view active">
                <div style="margin-bottom: 20px;">
                    <h2 style="color: var(--dark);">Fee Management</h2>
                    <p style="color: var(--secondary); font-size: 0.9rem;">Search for a student to view or update fees.</p>
                </div>
                
                <div class="search-card">
                    <i class="fas fa-search" style="color: var(--secondary); margin-left: 10px;"></i>
                    <input type="text" id="lrnInput" class="search-input" placeholder="Enter Student LRN..." style="border: none;" onkeypress="if(event.key==='Enter') runSearch()">
                    
                    <button class="login-btn" onclick="openAnnounceModal()" style="width: auto; padding: 10px 15px; background: #e63946; margin-right: 10px; margin-left:10px;" title="Post Announcement">
                        <i class="fas fa-bullhorn"></i> Post Announce
                    </button>

                    <button class="login-btn" onclick="toggleCamera()" style="width: auto; padding: 10px 20px; background: var(--dark); margin-right: 10px;">
                        <i class="fas fa-camera"></i> Scan QR
                    </button>
                    
                    <button onclick="runSearch()" class="login-btn" style="width: auto; padding: 10px 30px;">Search</button>

                    <div id="scanner-container">
                        <button class="close-cam-btn" onclick="stopCamera()">Close Camera</button>
                        <div id="reader"></div>
                    </div>
                </div>

                <div id="editSection" class="hidden">
                    <input type="hidden" id="rowIndex">
                    
                    <div class="dashboard-grid">
                        <div class="fee-card" style="grid-column: 1 / -1; border-left: 5px solid var(--primary);">
                            <h3 style="color: var(--secondary); font-size: 0.85rem; letter-spacing: 1px;">STUDENT DETAILS</h3>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--dark); margin-top: 5px;" id="nameDisplay"></div>
                            <div style="color: var(--secondary);">LRN: <span id="lrnDisplay" style="font-weight: 600;"></span></div>
                        </div>

                        <div class="fee-card">
                            <h4 style="margin-bottom: 10px;">PTA Fee</h4>
                            <input type="number" id="ptaFee" class="search-input" style="margin-bottom: 10px;" oninput="checkAutoPaid('ptaFee', 'ptaStat')">
                            <select id="ptaStat" class="status-select" onchange="updateColor(this)">
                                <option value="Paid">Paid</option>
                                <option value="Pending">Pending</option>
                                <option value="Overdue">Overdue</option>
                            </select>
                        </div>

                        <div class="fee-card">
                            <h4 style="margin-bottom: 10px;">Misc Fee</h4>
                            <input type="number" id="miscFee" class="search-input" style="margin-bottom: 10px;" oninput="checkAutoPaid('miscFee', 'miscStat')">
                            <select id="miscStat" class="status-select" onchange="updateColor(this)">
                                <option value="Paid">Paid</option>
                                <option value="Pending">Pending</option>
                                <option value="Overdue">Overdue</option>
                            </select>
                        </div>

                        <div class="fee-card">
                            <h4 style="margin-bottom: 10px;">ID Fee</h4>
                            <input type="number" id="idFee" class="search-input" style="margin-bottom: 10px;" oninput="checkAutoPaid('idFee', 'idStat')">
                            <select id="idStat" class="status-select" onchange="updateColor(this)">
                                <option value="Paid">Paid</option>
                                <option value="Pending">Pending</option>
                                <option value="Overdue">Overdue</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; margin-top: 25px;">
                        <button onclick="saveChanges()" class="login-btn" style="background: var(--success); width: auto; padding: 12px 40px;">
                            <i class="fas fa-save"></i> Save Updates
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-students" class="section-view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="color: var(--dark);">Registered Students</h2>
                        <p style="color: var(--secondary); font-size: 0.9rem;">View all students from the database.</p>
                    </div>
                    <button onclick="loadStudents()" class="login-btn" style="width: auto; padding: 10px 20px; font-size: 0.9rem; background: var(--secondary);">
                        <i class="fas fa-sync-alt"></i> Refresh List
                    </button>
                </div>

                <div class="table-container">
                    <table class="student-table">
                        <thead>
                            <tr>
                                <th>LRN</th>
                                <th>Name</th>
                                <th style="text-align: right;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr><td colspan="3" style="text-align: center; color: var(--secondary);">Click 'Refresh List' to load data.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

<script>
    // ------------------------------------------------------------------
    // PASTE YOUR GOOGLE SCRIPT URL HERE
    // ------------------------------------------------------------------
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzlFOu-d4cvNfMB4j6kIIv0dgEXvczDcSiU7--6Gemdtu4ctxxD2nK4ML-KiegTr1fp/exec"; 
    
    // Global Scanner Variable
    let html5QrcodeScanner = null;
    let clockInterval = null; // Variable for the live clock

    // --- LOGIN LOGIC ---
    function handleLoginEnter(e) { if(e.key === 'Enter') checkLogin(); }

    function checkLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        
        if (u === "OsiasRegistrar" && p === "OHS2005") {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
        } else {
            const err = document.getElementById('loginError');
            err.innerText = "Invalid credentials.";
            const card = document.querySelector('.login-card');
            card.style.transform = "translateX(10px)";
            setTimeout(() => card.style.transform = "translateX(-10px)", 100);
            setTimeout(() => card.style.transform = "translateX(0)", 200);
        }
    }

    // --- NEW: ANNOUNCEMENT MODAL FUNCTIONS ---
    
    // 1. Open the Modal & Start Clock
    function openAnnounceModal() {
        const modal = document.getElementById('announce-overlay');
        modal.style.display = 'flex';
        document.getElementById('announce-msg').value = ""; // Clear previous text
        document.getElementById('announce-msg').focus();

        // Start Live Clock
        updateModalClock(); // Run once immediately
        clockInterval = setInterval(updateModalClock, 1000); // Update every second
    }

    // 2. Close the Modal & Stop Clock
    function closeAnnounceModal() {
        document.getElementById('announce-overlay').style.display = 'none';
        if (clockInterval) clearInterval(clockInterval); // Stop timer to save resources
    }

    // 3. Logic to update the time text
    function updateModalClock() {
        const now = new Date();
        const options = { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
        document.getElementById('modalClock').innerText = now.toLocaleString('en-US', options);
    }

    // 4. Submit logic (Replaces the old Prompt logic)
    function submitAnnouncement() {
        const msg = document.getElementById('announce-msg').value.trim();
        
        if(!msg) {
            alert("Please type a message first.");
            return;
        }

        toggleLoader(true);
        fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "setAnnouncement", message: msg })
        })
        .then(r => r.json())
        .then(d => {
            toggleLoader(false);
            if(d.success) {
                showNotif("Announcement Posted Successfully!", "success");
                closeAnnounceModal(); // Close window on success
            } else {
                showNotif("Error posting announcement.", "red");
            }
        })
        .catch(e => {
            toggleLoader(false);
            showNotif("Connection Error", "red");
        });
    }

    // --- NAVIGATION LOGIC ---
    function switchTab(tabName) {
        document.querySelectorAll('.section-view').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        if (tabName === 'fees') {
            document.getElementById('view-fees').classList.add('active');
            document.getElementById('nav-fees').classList.add('active');
        } else if (tabName === 'students') {
            document.getElementById('view-students').classList.add('active');
            document.getElementById('nav-students').classList.add('active');
            loadStudents(); 
        }
    }

    // --- UI UTILITIES ---
    function toggleLoader(show) { 
        document.getElementById('loader').style.display = show ? 'flex' : 'none'; 
    }

    function showNotif(msg, type) {
        const el = document.getElementById("notification");
        el.innerText = msg;
        el.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
    }

    function updateColor(el) {
        el.classList.remove('status-paid', 'status-pending', 'status-overdue');
        el.classList.add('status-' + el.value.toLowerCase());
    }

    function checkAutoPaid(inputId, selectId) {
        const val = document.getElementById(inputId).value;
        const select = document.getElementById(selectId);
        if (val !== '' && parseFloat(val) === 0) {
            select.value = "Paid";
            updateColor(select);
        }
    }

    // --- LIVE QR SCANNER LOGIC ---
    function toggleCamera() {
        const container = document.getElementById('scanner-container');
        if (container.style.display === "block") return;

        container.style.display = "block";
        
        if (!html5QrcodeScanner) {
            html5QrcodeScanner = new Html5Qrcode("reader");
        }

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            container.style.display = "none";
            showNotif("Camera Error: " + err, "red");
        });
    }

    function stopCamera() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById('scanner-container').style.display = "none";
            }).catch(err => console.log("Stop failed", err));
        } else {
            document.getElementById('scanner-container').style.display = "none";
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        stopCamera();
        document.getElementById('lrnInput').value = decodedText;
        showNotif("QR Detected! Searching...", "success");
        runSearch();
    }

    // --- STUDENT LIST (GET) ---
    function loadStudents() {
        toggleLoader(true);
        fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getStudents" })
        })
        .then(response => response.json())
        .then(data => {
            toggleLoader(false);
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = ""; 
            
            if (data.students && data.students.length > 0) {
                data.students.forEach(s => {
                    const row = `
                        <tr>
                            <td>${s.lrn}</td>
                            <td>${s.name}</td>
                            <td style="text-align: right;">
                                <button class="btn-sm" onclick="manageStudent('${s.lrn}')">
                                    <i class="fas fa-edit"></i> Manage Fees
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align: center;">No students found in database.</td></tr>`;
            }
        })
        .catch(err => {
            toggleLoader(false);
            showNotif("Failed to load students.", "red");
        });
    }

    function manageStudent(lrn) {
        switchTab('fees');
        document.getElementById('lrnInput').value = lrn;
        runSearch();
    }

    // --- FEE MANAGEMENT (SEARCH & UPDATE) ---
    function runSearch() {
        const lrn = document.getElementById("lrnInput").value;
        if (!lrn) return showNotif("Please enter an LRN", "red");

        toggleLoader(true);
        document.getElementById("editSection").classList.add("hidden"); 

        fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "search", lrn: lrn })
        })
        .then(response => response.json())
        .then(data => {
            toggleLoader(false);
            if (data.found) {
                document.getElementById("editSection").classList.remove("hidden");
                
                document.getElementById("rowIndex").value = data.rowIndex;
                document.getElementById("nameDisplay").innerText = data.name;
                document.getElementById("lrnDisplay").innerText = lrn;

                const setVal = (id, val) => {
                    const el = document.getElementById(id);
                    el.value = val;
                    if(el.tagName === 'SELECT') updateColor(el);
                };

                setVal("ptaFee", data.pta_fee);
                setVal("ptaStat", data.pta_stat);
                setVal("miscFee", data.misc_fee);
                setVal("miscStat", data.misc_stat);
                setVal("idFee", data.id_fee);
                setVal("idStat", data.id_stat);
            } else {
                showNotif("Student LRN not found.", "red");
            }
        })
        .catch(err => {
            toggleLoader(false);
            showNotif("Connection Error.", "red");
        });
    }

    function saveChanges() {
        toggleLoader(true);
        const payload = {
            action: "update",
            row: document.getElementById("rowIndex").value,
            ptaFee: document.getElementById("ptaFee").value,
            ptaStat: document.getElementById("ptaStat").value,
            miscFee: document.getElementById("miscFee").value,
            miscStat: document.getElementById("miscStat").value,
            idFee: document.getElementById("idFee").value,
            idStat: document.getElementById("idStat").value
        };

        fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            toggleLoader(false);
            if (data.success) {
                showNotif("Fees updated successfully!", "success");
                document.getElementById("editSection").classList.add("hidden");
                document.getElementById("lrnInput").value = ""; 
            } else {
                showNotif("Error: " + data.error, "red");
            }
        })
        .catch(err => {
            toggleLoader(false);
            showNotif("Save failed.", "red");
        });
    }
</script>

</body>
</html>